<!DOCTYPE html>
<html>
<head>
  <title>Playsculpt - Powering Imagination</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="google-site-verification" content="JJ05bpYy54yP_9jul28FM8ew7DtpaiHhA7eLYADtEEs" />

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    body {
      font-family: Verdana, Arial, sans-serif;
      background-color: #E3E3E3;
      margin: 0;
      padding: 0;
    }
    a {
      color: #0000FF;
    }
    #pageContainer {
      max-width: 960px;
      width: 100%;
      margin: 0 auto;
      background-color: #FFFFFF;
      box-sizing: border-box;
    }
    .header {
      background-color: #0053A1;
      color: #FFFFFF;
      padding: 5px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .header .logo {
      font-size: 2em;
      font-weight: bold;
    }
    .header a {
      color: #FFFFFF;
      text-decoration: none;
      padding: 0 4px;
    }
    .content-wrapper {
      display: flex;
      flex-wrap: wrap;
      padding: 10px;
    }
    .sidebar {
      width: 220px;
      padding-right: 20px;
      box-sizing: border-box;
    }
    .main-content {
      flex: 1;
      min-width: 300px;
    }
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.8em;
      color: #666666;
    }
    hr {
      border: 0;
      height: 1px;
      background: #ccc;
    }
    input[type="text"], input[type="password"], input[type="number"], textarea, select, input[type="date"] {
        width: 95%;
        padding: 8px;
        margin: 4px 0;
        box-sizing: border-box;
    }
    input[type="submit"], input[type="button"], button {
        padding: 8px 12px;
        cursor: pointer;
    }
    img {
      max-width: 100%;
      height: auto;
    }

    #createView {
        display: none;
        width: 100%;
    }
    #editorToolbar {
        padding: 5px;
        background: #f0f0f0;
        border-bottom: 1px solid #ccc;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }
    #grid-container {
        display: grid;
        grid-template-columns: repeat(32, 1fr);
        grid-template-rows: repeat(32, 1fr);
        width: 600px;
        height: 600px;
        border: 1px solid #333;
        margin-top: 10px;
        background-color: #fdfdfd;
        touch-action: none;
    }
    .grid-cell {
        border: 1px solid #eee;
        background-color: #ffffff;
    }
    .grid-cell:hover {
        outline: 1px solid #007bff;
        cursor: pointer;
    }
    #editorToolbar button.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1001; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%;
        overflow: auto; 
        background-color: rgb(0,0,0); 
        background-color: rgba(0,0,0,0.4); 
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto; 
        padding: 20px;
        border: 1px solid #888;
        width: 80%; 
        max-width: 900px;
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close-button:hover, .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }


    @media (max-width: 768px) {
      .content-wrapper {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        padding-right: 0;
        margin-bottom: 20px;
      }
      .header {
        flex-direction: column;
        text-align: center;
      }
      .header .nav {
        margin-top: 10px;
      }
      #grid-container {
        width: 95vw;
        height: 95vw;
        max-width: 600px;
        max-height: 600px;
      }
    }
  </style>
</head>

<body>

  <div id="adminBanner" style="display: none; text-align: center; padding: 5px;"></div>

  <div id="pageContainer">
    <div class="header">
        <div class="logo">Playsculpt <span id="online-count" style="font-size: 0.5em; font-weight: normal;"></span></div>
        <div class="nav">
            <a href="#" onclick="navigateTo('home')"><b>My Playsculpt</b></a> |
            <a href="#" onclick="navigateTo('create')"><b>Create</b></a> |
            <span id="sculptTestMessagesLink" style="display:none;"><a href="#" onclick="navigateTo('sculpt_test_messages')"><b>SculptTest Messages</b></a> |</span>
            <a href="#" onclick="navigateTo('games')"><b>Games</b></a> |
            <a href="#"><b>Catalog</b></a> |
            <a href="#" onclick="showForumsView()"><b>Forums</b></a> |
            <a href="#"><b>Search</b></a>
        </div>
    </div>

    <div class="content-wrapper">
        <div class="sidebar">
          <div id="authArea">
              </div>
          <div id="userInfoArea" align="center" style="display:none;">
             </div>
          <hr>
          <h3>Playsculpt News</h3>
          - Manual Save in Studio!<br>
          - Summer building contest begins.<br>
          - Trading system is now LIVE!
        </div>

        <div class="main-content">
          <div id="mainContent">
            <h2>Welcome to Playsculpt!</h2>
            <p>The ultimate 2D platform for playing, creating, and sharing experiences. What will you build today?</p>
            <div id="forumSpotlight" style="display:none; border: 1px solid #999999; padding: 10px;">
                <h3>Forum Spotlight</h3>
                <hr>
                <div id="spotlightContent"></div>
            </div>
            <br>
            <h3>Featured Games</h3>
            <hr>
            <table width="100%" border="0" cellpadding="5" cellspacing="5">
              <tr align="center">
                <td width="33%" valign="top"><img src="https://placehold.co/150x100/CCCCCC/000000?text=Block+Battle" alt="Block Battle Game"><br><b><a href="#">Block Battle Arena</a></b><br>By: Constructor_Carl<br><input type="button" value="Play" onclick="launchGame('Block Battle Arena')"></td>
                <td width="33%" valign="top"><img src="https://placehold.co/150x100/DDDDDD/000000?text=Platformer" alt="Escape the Platformer Game"><br><b><a href="#">Escape the Treacherous Platformer</a></b><br>By: SpeedySamantha<br><input type="button" value="Play" onclick="launchGame('Escape the Treacherous Platformer')"></td>
                <td width="33%" valign="top"><img src="https://placehold.co/150x100/EEEEEE/000000?text=Tycoon" alt="Tycoon Game"><br><b><a href="#">Build Your Dream House Tycoon</a></b><br>By: TycoonKing<br><input type="button" value="Play" onclick="launchGame('Build Your Dream House Tycoon')"></td>
              </tr>
            </table>
          </div>
          <div id="forumView" style="display:none;"></div>
          <div id="sculptTestHubView" style="display:none;"></div>
          <div id="createView"></div>
        </div>
    </div>
      
    <div class="footer">
      <hr>
      Copyright &copy; 2025 Playsculpt Corporation. All Rights Reserved.<br>
      <a href="#">About Us</a> | <a href="#">Jobs</a> | <a href="#">Terms of Service</a> | <a href="#">Privacy Policy</a>
    </div>
  </div>

  <div id="chatLogModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeChatLogModal()">&times;</span>
            <h2>SculptTest Chat Logs</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="logSearch" placeholder="Search phrase..." style="flex-grow: 1;">
                <input type="text" id="logUserSearch" placeholder="Filter by username..." style="flex-grow: 1;">
                <input type="date" id="logDateFilter">
                <button onclick="renderChatLogs()">Search</button>
            </div>
            <div id="logContent" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; background: #f9f9f9;"></div>
            <div id="logPagination" style="text-align: center; margin-top: 10px;"></div>
        </div>
    </div>


  <script type="text/javascript">
    // --- Global State ---
    let currentUser = null;
    let forumDataCache = null;
    let userStatsCache = null;
    let testHubCache = null;
    let adminBannerCache = null;
    let editorInitialized = false;
    let autosaveInterval = null;
    let socket = io();
    let allChatLogs = [];
    let currentPage = 1;
    const logsPerPage = 100;

    // 2D Editor State
    let gridData = {};
    let currentTool = 'paint';
    let selectedColor = '#000000';
    const gridSize = 32;
    let isDrawing = false;


    // --- Socket.IO ---
    socket.on('userCount', (count) => {
        document.getElementById('online-count').innerText = `(${count} Online)`;
    });

    // --- Admin Banner ---
    async function fetchAndRenderBanner() {
        try {
            const response = await fetch('/admin/banner');
            const result = await response.json();
            const bannerDiv = document.getElementById('adminBanner');
            if (result.success && result.banner) {
                adminBannerCache = result.banner;
                if (adminBannerCache.enabled) {
                    bannerDiv.style.display = 'block';
                    bannerDiv.style.backgroundColor = adminBannerCache.backgroundColor;
                    bannerDiv.style.color = adminBannerCache.textColor;
                    bannerDiv.style.fontSize = adminBannerCache.fontSize + 'px';
                    // The message is sanitized on the server, so it's safe to use innerHTML here.
                    bannerDiv.innerHTML = adminBannerCache.message;
                } else {
                    bannerDiv.style.display = 'none';
                }
            } else {
                bannerDiv.style.display = 'none';
            }
        } catch (error) {
            console.error("Could not fetch admin banner:", error);
        }
    }

    function renderAdminBannerControls() {
        const banner = adminBannerCache;
        if (!banner) return '';
        let html = `<hr><h3>Admin Banner Controls</h3>`;
        html += `<form onsubmit="handleUpdateBanner(event)">`;
        html += `Message:<br><input type="text" id="bannerMessage" value="${banner.message}"><br>`;
        html += `BG Color: <input type="color" id="bannerBgColor" value="${banner.backgroundColor}"><br>`;
        html += `Text Color: <input type="color" id="bannerTextColor" value="${banner.textColor}"><br>`;
        html += `Font Size (px): <input type="number" id="bannerFontSize" value="${banner.fontSize}" style="width: 80px;"><br>`;
        html += `<input type="checkbox" id="bannerEnabled" ${banner.enabled ? 'checked' : ''}> Enable Banner<br>`;
        html += `<input type="submit" value="Update Banner">`;
        html += `</form>`;
        return html;
    }

    async function handleUpdateBanner(event) {
        event.preventDefault();
        const bannerData = {
            message: document.getElementById('bannerMessage').value,
            backgroundColor: document.getElementById('bannerBgColor').value,
            textColor: document.getElementById('bannerTextColor').value,
            fontSize: document.getElementById('bannerFontSize').value,
            enabled: document.getElementById('bannerEnabled').checked
        };
        try {
            const response = await fetch('/admin/banner', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bannerData)
            });
            const result = await response.json();
            alert(result.message);
            if(result.success) {
                fetchAndRenderBanner();
            }
        } catch(error) {
            alert('Error updating banner: ' + error.message);
        }
    }

    // --- Forum Rendering ---
    async function showForumsView() {
        if (!currentUser || currentUser.role === 'guest') {
            alert('You must be logged in to a registered account to access the forums.');
            return;
        }
        navigateTo('forums');
    }
    async function renderForum(view = 'categories', id = null) {
        const forumViewDiv = document.getElementById('forumView');
        try {
            // Re-fetch data each time to ensure it's fresh
            const response = await fetch('/forums');
            if (!response.ok) throw new Error('Failed to fetch forum data.');
            const data = await response.json();
            forumDataCache = data.forumData;
            userStatsCache = data.userStats;
        } catch (error) {
            console.error('Error fetching forums:', error);
            forumViewDiv.innerHTML = '<font color="red">Could not load forums. Please try again later.</font>';
            return;
        }
        if (view === 'categories') renderCategories();
        if (view === 'posts') renderPosts(id);
        if (view === 'post_view') renderPostView(id);
        if (view === 'create_post') renderCreatePostForm();
    }
    function renderCategories() {
        const categories = forumDataCache.categories;
        let html = '<h3>Forum Categories</h3>';
        html += ' <input type="button" value="Create Post" onclick="renderForum(\'create_post\')">';
        html += '<hr>';
        html += '<div style="border: 1px solid #ccc; padding: 8px; margin-bottom: 10px; background-color: #f9f9f9;"><b>Forum Guidelines</b><br><small>Help us keep forums organized and on topic... Moderators have the right to relocate where posts go... Breaking these rules will result in either a ban or warning...</small></div>';
        html += '<table width="100%" border="0" cellpadding="5" cellspacing="0">';
        if (categories && categories.length > 0) {
            categories.forEach(cat => {
                html += `<tr><td><a href="#" onclick="renderForum('posts', ${cat.id})">${cat.name}</a>`;
                if (cat.label) {
                    html += `<br><small><i>${cat.label}</i></small>`;
                }
                html += `</td></tr>`;
            });
        } else {
             html += '<tr><td>No categories available.</td></tr>';
        }
        html += '</table>';
        document.getElementById('forumView').innerHTML = html;
    }
    function renderPosts(categoryId) {
        const category = forumDataCache.categories.find(c => c.id === categoryId);
        if (category && category.special === 'testhub_link') {
            navigateTo('sculpt_test_hub');
            return;
        }
        const posts = forumDataCache.posts.filter(p => p.categoryId === categoryId);
        let html = `<h3>${category.name}</h3> <input type="button" value="&laquo; Back to Categories" onclick="renderForum()"> <input type="button" value="Create Post" onclick="renderForum(\'create_post\')"><hr>`;
        if(category.label) {
            html += `<p><i>${category.label}</i></p><hr>`;
        }
        html += '<table width="100%" border="0" cellpadding="5" cellspacing="0">';
        if (posts.length > 0) {
            posts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(post => {
                let likesText = (category.special === 'no_replies_likeable') ? ` - Likes: ${(post.likes || []).length}` : '';
                html += `<tr><td><a href="#" onclick="renderForum('post_view', '${post.id}')">${post.title}</a> by ${renderUsernameWithTooltip(post.author)}${likesText}</td></tr>`;
            });
        } else {
            html += '<tr><td>No posts in this category yet.</td></tr>';
        }
        html += '</table>';
        document.getElementById('forumView').innerHTML = html;
    }
    function renderPostView(postId) {
        const post = forumDataCache.posts.find(p => p.id === postId);
        if (!post) { document.getElementById('forumView').innerHTML = 'Post not found.'; return; }
        const category = forumDataCache.categories.find(c => c.id === post.categoryId);
        let html = `<input type="button" value="&laquo; Back to Posts" onclick="renderForum('posts', ${post.categoryId})"><hr><h3>${post.title}</h3><p>By ${renderUsernameWithTooltip(post.author)} on ${new Date(post.timestamp).toLocaleString()}</p>`;
        if (currentUser && currentUser.role === 'admin') {
            html += `<div style="border: 1px dashed red; padding: 5px; margin-bottom: 10px;"><b>Admin Controls:</b><br><input type="button" value="Award Hall of Fame" onclick="handleAwardBadge('${post.author}')"> <input type="button" value="Give Spotlight" onclick="handleAwardSpotlight('${post.id}')"> <input type="button" value="Relocate Post" onclick="showRelocateUI('${post.id}')"> <input type="button" value="Delete Post" onclick="handleDeletePost('${post.id}')"><div id="relocateUi-${post.id}" style="display:none; margin-top: 5px;"></div></div>`;
        }
        if (post.imageUrl) {
            html += `<img src="${post.imageUrl}" alt="User uploaded image" style="max-width: 400px; border: 1px solid #ccc; padding: 5px;"><br><br>`;
        }
        // Content is sanitized server-side, safe to render
        html += `<p style="border:1px solid #ccc; padding:10px;">${post.content}</p>`;
        if (category.special === 'no_replies_likeable') {
            const likesCount = (post.likes || []).length;
            const hasLiked = post.likes && post.likes.includes(currentUser.username);
            html += `<hr><p><b>Likes: ${likesCount}</b></p>`;
            if (!hasLiked) {
                html += `<input type="button" value="Like Post" onclick="handleLikePost('${post.id}')">`;
            } else {
                html += `<p><i>You have liked this post.</i></p>`;
            }
        } else {
            html += '<hr><h4>Replies</h4>';
            if (post.replies && post.replies.length > 0) {
                post.replies.forEach(reply => {
                    html += `<div style="border:1px solid #ddd; padding:5px; margin-bottom:5px;"><p>${renderUsernameWithTooltip(reply.author)} says:</p><p>${reply.content}</p>`;
                    if (currentUser && currentUser.role === 'admin') {
                        html += `<input type="button" value="Delete Reply" onclick="handleDeleteReply('${post.id}', '${reply.id}')">`;
                    }
                    html += `</div>`;
                });
            } else {
                html += '<p>No replies yet.</p>';
            }
            html += `<hr><h5>Reply to this post:</h5>`;
            if (category.special === 'counting_game') {
                const lastReply = post.replies[post.replies.length - 1];
                const nextNumber = lastReply ? parseInt(lastReply.content, 10) + 1 : 1;
                html += `<p><i>Next number must be: <b>${nextNumber}</b>. Only enter numbers.</i></p>`;
            }
            html += `<textarea id="replyContent" rows="5" maxlength="1000"></textarea><br><input type="button" value="Post Reply" onclick="handleReply('${post.id}')">`;
        }
        document.getElementById('forumView').innerHTML = html;
    }
    function renderCreatePostForm() {
        let html = '<input type="button" value="&laquo; Back to Categories" onclick="renderForum()"><h3>Create a New Post</h3><form id="createPostForm" onsubmit="handleCreatePost(event)">Title (1-75 chars):<br><input type="text" id="postTitle" name="title" maxlength="75" required><br><br>Category:<br><select id="postCategory" name="categoryId" onchange="toggleImageUpload(this.value)">';
        forumDataCache.categories.forEach(cat => {
            html += `<option value="${cat.id}">${cat.name}</option>`;
        });
        html += '</select><br><br><div id="imageUploadSection" style="display:none;">Image (Optional, max 5MB):<br><input type="file" id="postImage" name="image" accept="image/png, image/jpeg, image/gif"><br><br></div>Content (max 2000 chars):<br><textarea id="postContent" name="content" rows="10" maxlength="2000" required></textarea><br><br><input type="submit" value="Submit Post"></form>';
        document.getElementById('forumView').innerHTML = html;
        toggleImageUpload(document.getElementById('postCategory').value);
    }
    function toggleImageUpload(categoryId) {
        const category = forumDataCache.categories.find(c => c.id == categoryId);
        document.getElementById('imageUploadSection').style.display = (category && category.special === 'image_upload') ? 'block' : 'none';
    }
    function renderUsernameWithTooltip(username) {
        const stats = userStatsCache[username];
        if (!stats) return username;
        const tooltipText = `Posts: ${stats.postCount}\nReplies: ${stats.replyCount}\nBadges: ${stats.badges.join(', ') || 'None'}`;
        return `<span title="${tooltipText}" style="cursor:help; border-bottom:1px dotted #000;">${username}</span>`;
    }
    async function handleCreatePost(event) {
        event.preventDefault();
        const form = document.getElementById('createPostForm');
        const formData = new FormData(form);
        // Username is no longer needed in form data, it's taken from the session on the server
        try {
            const response = await fetch('/forums/post', { method: 'POST', body: formData });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            alert(`Post created! ${result.badgeAwardedMessage || ''}`);
            renderForum('post_view', result.post.id);
        } catch (error) {
            alert('Error creating post: ' + error.message);
        }
    }
    async function handleReply(postId) {
        const content = document.getElementById('replyContent').value;
        if (!content.trim()) { alert('Reply cannot be empty.'); return; }
        try {
            const response = await fetch('/forums/reply', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content, postId }) });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            renderForum('post_view', postId);
        } catch (error) {
            alert('Error posting reply: ' + error.message);
        }
    }
    async function handleLikePost(postId) {
        try {
            const response = await fetch('/forums/like', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ postId }) });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            alert(result.message);
            renderForum('post_view', postId);
        } catch (error) {
            alert('Error liking post: ' + error.message);
        }
    }
    async function handleAwardBadge(targetUsername) {
        if (!confirm(`Award "Forum Hall of Fame" to ${targetUsername}?`)) return;
        try {
            const response = await fetch('/admin/award-badge', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ targetUsername }) });
            const result = await response.json();
            alert(result.message);
        } catch (error) {
            alert('An error occurred: ' + error.message);
        }
    }
    async function handleAwardSpotlight(postId) {
        if (!confirm('Make this post the Forum Spotlight?')) return;
        try {
            const response = await fetch('/admin/award-spotlight', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ postId }) });
            const result = await response.json();
            alert(result.message);
            if(result.success) fetchAndRenderSpotlight();
        } catch (error) {
             alert('An error occurred: ' + error.message);
        }
    }
    async function handleDeleteSpotlight() {
        if (!confirm('Remove the Forum Spotlight?')) return;
        try {
            const response = await fetch('/admin/delete-spotlight', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
            const result = await response.json();
            alert(result.message);
            if(result.success) fetchAndRenderSpotlight();
        } catch (error) {
            alert('An error occurred: ' + error.message);
        }
    }
    async function handleDeletePost(postId) {
        if (!confirm('PERMANENTLY delete this post and all its replies?')) return;
        try {
            const response = await fetch('/admin/delete-post', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ postId }) });
            const result = await response.json();
            alert(result.message);
            if(result.success) renderForum('categories');
        } catch(error) {
            alert('An error occurred: ' + error.message);
        }
    }
    async function handleDeleteReply(postId, replyId) {
        if (!confirm('PERMANENTLY delete this reply?')) return;
        try {
            const response = await fetch('/admin/delete-reply', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ postId, replyId }) });
            const result = await response.json();
            alert(result.message);
            if(result.success) renderForum('post_view', postId);
        } catch(error) {
            alert('An error occurred: ' + error.message);
        }
    }
    function showRelocateUI(postId) {
        const relocateDiv = document.getElementById(`relocateUi-${postId}`);
        if(relocateDiv.style.display === 'block') { relocateDiv.style.display = 'none'; return; }
        let selectHtml = '<select id="relocateCategorySelect">';
        forumDataCache.categories.forEach(c => { selectHtml += `<option value="${c.id}">${c.name}</option>`; });
        selectHtml += `</select> <input type="button" value="Confirm" onclick="handleRelocatePost('${postId}')">`;
        relocateDiv.innerHTML = selectHtml;
        relocateDiv.style.display = 'block';
    }
    async function handleRelocatePost(postId) {
        const newCategoryId = document.getElementById('relocateCategorySelect').value;
        const categoryName = forumDataCache.categories.find(c => c.id == newCategoryId).name;
        if (!confirm(`Move post to "${categoryName}"?`)) return;
        try {
            const response = await fetch('/admin/relocate-post', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ postId, newCategoryId }) });
            const result = await response.json();
            alert(result.message);
            if (result.success) renderForum('categories');
        } catch (error) {
            alert('An error occurred: ' + error.message);
        }
    }
    
    // --- SculptTest Hub ---
    function renderSculptTestHub(view = 'main', id = null) {
        if (!currentUser || currentUser.role === 'guest') {
            alert('You must be logged in to access the SculptTest Hub.');
            navigateTo('home');
            return;
        }
        navigateTo('sculpt_test_hub_view');
        const hubView = document.getElementById('sculptTestHubView');
        if (view === 'main') {
             hubView.innerHTML = `<h3>Welcome to the SculptTest Hub</h3><p>Post jobs or find jobs to earn currency!</p><hr><input type="button" value="Post a Testing Job" onclick="renderSculptTestHub('post_job_form')"> <input type="button" value="Find Testing Jobs" onclick="renderSculptTestHub('find_jobs')">`;
        }
        if (view === 'post_job_form') {
            hubView.innerHTML = `<h3>Post a Testing Job</h3><p>Post a job for your game...</p><hr><input type="button" value="&laquo; Back to Hub" onclick="renderSculptTestHub('main')"><br><br><form onsubmit="handlePostJob(event)">Job Title:<br><input type="text" id="jobTitle" required><br><br>Description:<br><textarea id="jobDesc" required rows="5"></textarea><br><br>Game Link:<br><input type="text" id="jobGameLink" required><br><br>Requirements:<br><input type="text" id="jobReqs"><br><br>Payment:<br><input type="number" id="jobAmount" required min="1"> <select id="jobPaymentMethod"><option value="Points">Points</option><option value="SculptCoins">SculptCoins</option></select><br><br><input type="checkbox" id="jobTos" required> I agree to the ToS.<br><br><input type="submit" value="Post Job & Deposit Escrow"></form>`;
        }
        if (view === 'find_jobs') { renderJobFindList(); }
        if (view === 'messages') { renderMyMessages(); }
        if (view === 'chat') { renderChatView(id); }
    }
    async function renderJobFindList() {
        const hubView = document.getElementById('sculptTestHubView');
        hubView.innerHTML = '<h3>Finding Jobs...</h3>';
        try {
            const response = await fetch('/testhub/jobs');
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            testHubCache = result.jobs;
            let html = `<h3>Available Jobs</h3> <input type="button" value="&laquo; Back" onclick="renderSculptTestHub('main')"><hr>`;
            if (result.jobs.length === 0) {
                html += '<p>No jobs available.</p>';
            } else {
                result.jobs.forEach(job => {
                    html += `<div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"><b>${job.title}</b> by ${job.posterUsername}<br>Paying: ${job.paymentAmount} ${job.paymentMethod}<br><p>${job.description.substring(0, 100)}...</p><input type="button" value="View & Apply" onclick="renderChatView('${job.id}')"></div>`;
                });
            }
            hubView.innerHTML = html;
        } catch (e) {
            hubView.innerHTML = `<font color="red">Error: ${e.message}</font>`;
        }
    }
    async function renderMyMessages() {
        const hubView = document.getElementById('sculptTestHubView');
        hubView.innerHTML = '<h3>Loading Messages...</h3>';
        try {
            const response = await fetch(`/testhub/messages`);
            const result = await response.json();
            if(!result.success) throw new Error(result.message);
            testHubCache = result.jobs;
            let html = `<h3>My Messages</h3> <input type="button" value="&laquo; Back" onclick="renderSculptTestHub('main')"><hr>`;
            if(result.jobs.length === 0) {
                html += "<p>No active jobs or applications.</p>";
            } else {
                 result.jobs.forEach(job => {
                    let role = job.posterUsername === currentUser.username ? 'Poster' : 'Applicant/Tester';
                    html += `<div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"><b>${job.title}</b> (Role: ${role})<br>Status: <b>${job.status}</b><br><input type="button" value="Open Chat" onclick="renderChatView('${job.id}')"></div>`;
                });
            }
            hubView.innerHTML = html;
        } catch(e) {
             hubView.innerHTML = `<font color="red">Error: ${e.message}</font>`;
        }
    }
    async function renderChatView(jobId) {
        const hubView = document.getElementById('sculptTestHubView');
        let job = testHubCache ? testHubCache.find(j => j.id === jobId) : null;
        if (!job) {
            const response = await fetch(`/testhub/messages`);
            const result = await response.json();
            if(!result.success) { hubView.innerHTML = 'Error: Could not load job details.'; return; }
            testHubCache = result.jobs;
            job = testHubCache.find(j => j.id === jobId);
            if(!job) { hubView.innerHTML = 'Error: Job not found.'; return; }
        }
        const isPoster = currentUser.username === job.posterUsername, isTester = currentUser.username === job.testerUsername, isApplicant = job.applicants.some(a => a.username === currentUser.username);
        let html = `<input type="button" value="&laquo; Back" onclick="navigateTo('sculpt_test_messages')"><hr><h3>${job.title}</h3><p><b>Desc:</b> ${job.description}</p><p><b>Link:</b> <a href="${job.gameLink}" target="_blank" rel="noopener noreferrer">${job.gameLink}</a></p><p><b>Reqs:</b> ${job.requirements||'None'}</p><p><b>Pay:</b> ${job.paymentAmount} ${job.paymentMethod}</p>`;
        if (isPoster && job.reports && job.reports.length > 0) {
            html += `<hr><h4>Submitted Reports</h4>`;
            job.reports.forEach(r => {
                html += `<div style="border: 1px solid #ddd; padding: 5px; margin-bottom: 5px;"><b>Report: ${r.title}</b><br><p>${r.findings}</p>`;
                if (r.attachments && r.attachments.length > 0) {
                    html += `Attachments: `;
                    r.attachments.forEach(a => { html += `<a href="${a}" target="_blank">File</a> `; });
                }
                html += `</div>`;
            });
        }
        html += `<hr><h4>Chat</h4><div id="chatBox" style="height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 5px; margin-bottom: 10px;">`;
        job.chat.forEach(m => { html += `<b>${m.sender}:</b> ${m.text}<br>`; });
        html += `</div><textarea id="chatMessage" rows="2"></textarea><input type="button" value="Send" onclick="handleSendMessage('${job.id}')">`;
        if (isPoster && job.status === 'open') {
             html += `<hr><h4>Applicants</h4>`;
             if (job.applicants.length > 0) { job.applicants.forEach(a => { html += `<p>${a.username} <input type="button" value="Accept" onclick="handleAcceptApplicant('${job.id}', '${a.username}')"></p>`; }); }
             else { html += `<p>No applicants yet.</p>` }
        }
        if (isTester && job.status === 'in_progress') {
            html += `<hr><h4>Submit Report</h4><form id="reportForm" onsubmit="handleSubmitReport(event, '${job.id}')">Title:<br><input type="text" name="title" required><br><br>Findings:<br><textarea name="findings" required rows="5"></textarea><br><br>Attachments:<br><input type="file" name="attachments" multiple><br><br><input type="submit" value="Submit"></form>`;
        }
        if (isPoster && job.status === 'in_progress') {
             html += `<hr><input type="button" value="Mark Complete & Release Payment" onclick="handleCompleteJob('${job.id}')">`;
        }
        if (!isPoster && !isTester && !isApplicant && job.status === 'open') {
            html += `<hr><input type="button" value="Apply for Job" onclick="handleApplyForJob('${job.id}')">`;
        }
        hubView.innerHTML = html;
        document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
    }
    async function handlePostJob(event) {
        event.preventDefault();
        const jobData = { title: document.getElementById('jobTitle').value, description: document.getElementById('jobDesc').value, gameLink: document.getElementById('jobGameLink').value, requirements: document.getElementById('jobReqs').value, amount: document.getElementById('jobAmount').value, paymentMethod: document.getElementById('jobPaymentMethod').value };
        if (!confirm(`This will deduct ${jobData.amount} ${jobData.paymentMethod} and place it in escrow. Proceed?`)) return;
        try {
            const response = await fetch('/testhub/job', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(jobData) });
            const result = await response.json();
            alert(result.message);
            if (result.success) {
                const currencyKey = jobData.paymentMethod === 'SculptCoins' ? 'sculptcoins' : 'points';
                currentUser.currencies[currencyKey] -= parseInt(jobData.amount, 10);
                showLoggedInState(currentUser);
                navigateTo('sculpt_test_messages');
            }
        } catch (error) { alert('Error: ' + error.message); }
    }
    async function handleApplyForJob(jobId) {
        try {
            const response = await fetch('/testhub/apply', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ jobId }) });
            const result = await response.json();
            alert(result.message);
            if (result.success) { testHubCache = null; renderChatView(jobId); }
        } catch (e) { alert('Error: ' + e.message); }
    }
    async function handleSendMessage(jobId) {
        const messageInput = document.getElementById('chatMessage');
        const text = messageInput.value.trim();
        if (!text) return;
        try {
            const response = await fetch('/testhub/message', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text, jobId }) });
            const result = await response.json();
            if (!result.success) { alert("Error: " + result.message); return; }
            messageInput.value = '';
            testHubCache = null;
            renderChatView(jobId);
        } catch (e) { alert('Error: ' + e.message); }
    }
    async function handleAcceptApplicant(jobId, applicantUsername) {
        if (!confirm(`Accept ${applicantUsername}? This closes the job to others.`)) return;
         try {
            const response = await fetch('/testhub/accept', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ applicantUsername, jobId }) });
            const result = await response.json();
            alert(result.message);
            if (result.success) { testHubCache = null; renderChatView(jobId); }
        } catch (e) { alert('Error: ' + e.message); }
    }
    async function handleSubmitReport(event, jobId) {
        event.preventDefault();
        const form = document.getElementById('reportForm');
        const formData = new FormData(form);
        formData.append('jobId', jobId);
        try {
            const response = await fetch('/testhub/submit-report', { method: 'POST', body: formData });
            const result = await response.json();
            alert(result.message);
            if (result.success) { testHubCache = null; renderChatView(jobId); }
        } catch (err) { alert('Error: ' + err.message); }
    }
    async function handleCompleteJob(jobId) {
        if (!confirm("Are you sure you want to release payment? This is final.")) return;
        try {
            const response = await fetch('/testhub/complete-job', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ jobId }) });
            const result = await response.json();
            alert(result.message);
            if (result.success) navigateTo('sculpt_test_messages');
        } catch (e) { alert('Error: ' + e.message); }
    }

    // --- Page Navigation & Content Switching ---
    function navigateTo(page, id = null) {
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('forumView').style.display = 'none';
        document.getElementById('sculptTestHubView').style.display = 'none';
        document.getElementById('createView').style.display = 'none';
        
        if (autosaveInterval) {
            clearInterval(autosaveInterval);
            autosaveInterval = null;
        }

        if (page === 'create') {
            if (!currentUser || currentUser.role === 'guest') {
                alert('You must be logged in to a registered account to access the Create page.');
                navigateTo('home');
                return;
            }
            document.getElementById('createView').style.display = 'block';
            if (!editorInitialized) {
                initEditor();
            }
            loadScene();
            autosaveInterval = setInterval(saveScene, 30000);
        } else if (page === 'home' || page === 'games') {
            document.getElementById('mainContent').style.display = 'block';
        } else if (page === 'forums') {
            document.getElementById('forumView').style.display = 'block';
            renderForum();
        } else if (page === 'forum_post' && id) {
            document.getElementById('forumView').style.display = 'block';
            renderForum('post_view', id);
        } else if (page === 'sculpt_test_hub') {
            renderSculptTestHub('main');
        } else if (page === 'sculpt_test_hub_view') {
            document.getElementById('sculptTestHubView').style.display = 'block';
        } else if (page === 'sculpt_test_messages') {
            renderSculptTestHub('messages');
        }
    }


    // --- (UPDATED) Authentication & UI ---
    function launchGame(gameName) { alert("Starting " + gameName + "..."); }
    function showAuthArea(mode) { const a = document.getElementById('authArea'); if (mode === 'signup') { a.innerHTML = `<h3>Sign Up</h3><form onsubmit="handleSignup(event)">Username:<br><input type="text" id="signupUsername"><br>Password:<br><input type="password" id="signupPassword"><br><br><input type="submit" value="Sign Up"><br><br><a href="#" onclick="showAuthArea('login')">Already have an account?</a></form>`; } else { a.innerHTML = `<h3>Member Login</h3><form onsubmit="handleLogin(event)">Username:<br><input type="text" id="loginUsername"><br>Password:<br><input type="password" id="loginPassword"><br><br><input type="submit" value="Login"></form><br><a href="#" onclick="handleGuestLogin()"><b>Play as Guest</b></a><br><a href="#" onclick="showAuthArea('signup')"><b>Sign Up! It's Free!</b></a>`; } }
    function showLoggedInState(user) { document.getElementById('authArea').style.display = 'none'; if (user && user.role !== 'guest') { document.getElementById('sculptTestMessagesLink').style.display = 'inline'; } else { document.getElementById('sculptTestMessagesLink').style.display = 'none'; } const u = document.getElementById('userInfoArea'); u.style.display = 'block'; let h = `Hello, <b>${user.username}</b>!<br><br><img src="https://placehold.co/120x120/CCCCCC/000000?text=Avatar" alt="Your Avatar"><br><br>`; if (user.currencies) { h += `<table border="0" cellpadding="2" cellspacing="2" align="center" width="90%"><tr><td align="left">Diamonds:</td><td align="right">${user.currencies.diamonds}</td></tr><tr><td align="left">Sculptcoins:</td><td align="right">${user.currencies.sculptcoins}</td></tr><tr><td align="left">Points:</td><td align="right">${user.currencies.points}</td></tr></table>`; } h += `<a href="#" onclick="handleLogout()">Logout</a>`; if (user.role !== 'guest') { h += `<hr><h3>Account Settings</h3><form onsubmit="handleChangePassword(event)"><b>Change Password</b><br><input type="password" placeholder="Old" id="oldPassword"><br><input type="password" placeholder="New" id="newPassword"><br><input type="password" placeholder="Confirm" id="confirmNewPassword"><br><input type="submit" value="Update Password"></form><br><form onsubmit="handleChangeUsername(event)"><b>Change Username (10 Diamonds)</b><br><input type="text" placeholder="New Username" id="newUsername"><br><input type="password" placeholder="Password" id="currentPasswordForUName"><br><input type="submit" value="Update Username"></form>`; } if (user.role === 'admin') { h += renderAdminBannerControls(); } if (user.role === 'moderator' || user.role === 'admin') { h += `<hr><input type="button" value="View Chat Logs" onclick="openChatLogModal()">`; } u.innerHTML = h; }
    async function handleSignup(e) { e.preventDefault(); const u = document.getElementById('signupUsername').value, p = document.getElementById('signupPassword').value; try { const r = await fetch('/signup',{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})}), j = await r.json(); alert(j.message); if (r.ok) showAuthArea('login'); } catch (err) { alert('Signup failed: ' + err.message); } }
    async function handleLogin(e) { if(e) e.preventDefault(); const u = document.getElementById('loginUsername').value, p = document.getElementById('loginPassword').value; try { const r = await fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})}), j = await r.json(); if(!r.ok)throw new Error(j.message); currentUser = j.user; showLoggedInState(currentUser); } catch(err){ alert("Login failed: "+err.message); } }
    async function handleGuestLogin() { try { const r = await fetch("/guestlogin"), j = await r.json(); if(!r.ok) throw new Error(j.message); currentUser = j.user; showLoggedInState(currentUser); } catch(c) { alert("Guest login failed: "+c.message); } }
    async function handleLogout() { try { await fetch('/logout', { method: 'POST' }); } catch(e) { console.error("Logout failed", e); } finally { currentUser=null; document.getElementById("userInfoArea").style.display="none"; document.getElementById('sculptTestMessagesLink').style.display = 'none'; document.getElementById("authArea").style.display="block"; showAuthArea("login"); navigateTo("home"); } }
    async function handleChangePassword(e) { e.preventDefault(); const o=document.getElementById("oldPassword").value, n=document.getElementById("newPassword").value, c=document.getElementById("confirmNewPassword").value; if(n!==c){alert("New passwords do not match.");return} try{ const r=await fetch("/changepassword",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldPassword:o,newPassword:n})}), j=await r.json(); alert(j.message); if(r.ok)e.target.reset() }catch(err){alert("Error: "+err.message)} }
    async function handleChangeUsername(e) { e.preventDefault(); const n=document.getElementById("newUsername").value, p=document.getElementById("currentPasswordForUName").value; if(!confirm(`Change username to "${n}"? This costs 10 Diamonds.`))return; try{ const r=await fetch("/changeusername",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({newUsername:n,password:p})}), j=await r.json(); alert(j.message); if(r.ok){ currentUser = j.updatedUser; showLoggedInState(currentUser) } }catch(err){alert("Error: "+err.message)} }
    async function fetchAndRenderSpotlight() { try { const r = await fetch('/spotlight'), j = await r.json(), d = document.getElementById('forumSpotlight'), c = document.getElementById('spotlightContent'); if (j.success && j.post) { const p = j.post; let h = `<b>Title:</b> ${p.title}<br><b>By:</b> ${p.author}<br><br><i>${p.content.substring(0, 200)}...</i><br><br>`; if(currentUser && currentUser.role !== 'guest') { h += `<input type="button" value="Go to Post" onclick="navigateTo('forum_post', '${p.id}')"> `; } if(currentUser && currentUser.role === 'admin') { h += `<input type="button" value="Remove Spotlight" onclick="handleDeleteSpotlight()">`; } h += ``; c.innerHTML = h; d.style.display = 'block'; } else { d.style.display = 'none'; } } catch (e) { console.error('Could not fetch spotlight:', e); document.getElementById('forumSpotlight').style.display = 'none'; } }

    // --- 2D Editor Functions ---
    function initEditor() {
        const createView = document.getElementById('createView');
        if (createView.innerHTML !== "") return; // Avoid re-initializing

        const toolbarHTML = `
            <div id="editorToolbar">
                <input type="button" value="Save" onclick="saveScene()">
                <label for="colorPicker">Color:</label>
                <input type="color" id="colorPicker" value="${selectedColor}" onchange="selectedColor = this.value">
                <button id="paintTool" class="active" onclick="setTool('paint', this)">Paint</button>
                <button id="eraseTool" onclick="setTool('erase', this)">Erase</button>
                <span id="saveStatus"></span>
            </div>`;

        const gridHTML = `<div id="grid-container"></div>`;
        createView.innerHTML = toolbarHTML + gridHTML;
        const gridContainer = document.getElementById('grid-container');

        for (let i = 0; i < gridSize * gridSize; i++) {
            const cell = document.createElement('div');
            cell.classList.add('grid-cell');
            cell.dataset.x = i % gridSize;
            cell.dataset.y = Math.floor(i / gridSize);
            gridContainer.appendChild(cell);
        }

        const handleDraw = (e) => {
            if (e.buttons !== 1 && e.type !== 'mousedown') return; // Only draw on left-click drag
            let target = e.target;
            if (e.touches) {
                target = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
            }
            if (target && target.classList.contains('grid-cell')) {
                paintCell(target);
            }
            e.preventDefault();
        };

        gridContainer.addEventListener('mousedown', handleDraw);
        gridContainer.addEventListener('mousemove', handleDraw);
        gridContainer.addEventListener('touchstart', handleDraw, { passive: false });
        gridContainer.addEventListener('touchmove', handleDraw, { passive: false });
        
        editorInitialized = true;
    }

    function setTool(tool, element) {
        currentTool = tool;
        document.getElementById('paintTool').classList.remove('active');
        document.getElementById('eraseTool').classList.remove('active');
        element.classList.add('active');
    }

    function paintCell(cell) {
        const x = cell.dataset.x;
        const y = cell.dataset.y;
        const key = `${x},${y}`;

        if (currentTool === 'paint') {
            if(cell.style.backgroundColor !== selectedColor) {
               cell.style.backgroundColor = selectedColor;
            }
            gridData[key] = selectedColor;
        } else if (currentTool === 'erase') {
            if(cell.style.backgroundColor !== '') {
               cell.style.backgroundColor = '';
            }
            delete gridData[key];
        }
    }

    async function saveScene() {
        if (!currentUser || currentUser.role === 'guest') return;
        const saveStatus = document.getElementById('saveStatus');
        if (saveStatus) saveStatus.innerText = 'Saving...';
        
        try {
            // Username is sent via secure session cookie, not in body
            const response = await fetch('/studio/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sceneData: { grid: gridData } })
            });
            const result = await response.json();
            if (saveStatus) saveStatus.innerText = `Saved at ${new Date().toLocaleTimeString()}`;
        } catch (error) {
            if (saveStatus) saveStatus.innerText = 'Save failed.';
            console.error('Save error:', error);
        }
    }

    async function loadScene() {
        if (!currentUser || currentUser.role === 'guest') return;
        gridData = {};
        const cells = document.querySelectorAll('.grid-cell');
        if (!cells || cells.length === 0) {
            console.log("Editor not ready for loading, skipping.");
            return;
        }
        cells.forEach(cell => { cell.style.backgroundColor = ''; });
        
        try {
            // Username is determined by the server's session
            const response = await fetch(`/studio/load`);
            const result = await response.json();
            if (result.success && result.sceneData && result.sceneData.grid) {
                gridData = result.sceneData.grid;
                for (const key in gridData) {
                    const [x, y] = key.split(',');
                    const cell = document.querySelector(`.grid-cell[data-x='${x}'][data-y='${y}']`);
                    if (cell) {
                        cell.style.backgroundColor = gridData[key];
                    }
                }
            } else {
                console.log("No saved scene found or error loading.");
            }
        } catch (error) {
            console.error('Load error:', error);
        }
    }

    // --- Moderator Chat Log Functions ---
    async function openChatLogModal() {
        const modal = document.getElementById('chatLogModal');
        modal.style.display = "block";
        try {
            // Auth is handled by session cookie
            const response = await fetch(`/moderator/chatlogs`);
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            allChatLogs = result.logs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            currentPage = 1;
            renderChatLogs();
        } catch (error) {
            document.getElementById('logContent').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
        }
    }

    function closeChatLogModal() {
        document.getElementById('chatLogModal').style.display = "none";
    }

    function renderChatLogs() {
        const searchTerm = document.getElementById('logSearch').value.toLowerCase();
        const userTerm = document.getElementById('logUserSearch').value.toLowerCase();
        const dateTerm = document.getElementById('logDateFilter').value;
        let filteredLogs = allChatLogs;
        if (searchTerm) { filteredLogs = filteredLogs.filter(log => log.text.toLowerCase().includes(searchTerm)); }
        if (userTerm) { filteredLogs = filteredLogs.filter(log => log.sender.toLowerCase().includes(userTerm)); }
        if (dateTerm) { filteredLogs = filteredLogs.filter(log => log.timestamp.startsWith(dateTerm)); }
        const logContentDiv = document.getElementById('logContent');
        logContentDiv.innerHTML = '';
        const startIndex = (currentPage - 1) * logsPerPage;
        const endIndex = startIndex + logsPerPage;
        const paginatedLogs = filteredLogs.slice(startIndex, endIndex);
        if (paginatedLogs.length === 0) {
            logContentDiv.innerHTML = 'No logs found with the current filters.';
        } else {
             paginatedLogs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.style.borderBottom = '1px solid #eee';
                logElement.style.padding = '4px 0';
                logElement.innerHTML = `[${new Date(log.timestamp).toLocaleString()}] <b>${log.sender}</b>: ${log.text}`;
                logContentDiv.appendChild(logElement);
            });
        }
        renderPagination(filteredLogs.length);
    }

    function renderPagination(totalLogs) {
        const paginationDiv = document.getElementById('logPagination');
        paginationDiv.innerHTML = '';
        const totalPages = Math.ceil(totalLogs / logsPerPage);
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.innerText = i;
            if (i === currentPage) { pageButton.disabled = true; }
            pageButton.onclick = () => { currentPage = i; renderChatLogs(); };
            paginationDiv.appendChild(pageButton);
        }
    }

    // --- (UPDATED) Page Initialization ---
    async function initialize() {
        try {
            const response = await fetch('/check-session');
            const result = await response.json();
            if (result.success) {
                currentUser = result.user;
                showLoggedInState(currentUser);
            } else {
                currentUser = null;
                showAuthArea('login');
            }
        } catch(e) {
            console.error("Could not check session.", e);
            showAuthArea('login');
        }
        
        fetchAndRenderSpotlight();
        fetchAndRenderBanner();
    }
    
    // Start the application
    initialize();
  </script>

</body>
</html>